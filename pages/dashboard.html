<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Inventario</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">Sistema de Inventario</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">Productos</a>
                    </li>
                    <li class="nav-item" id="admin-panel-link">
                        <a class="nav-link" href="admin.html">Panel de Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Section -->
    <div class="container mt-5">
        <h1 class="mb-4">Dashboard</h1>
        
        <div id="dashboard-alert" class="alert d-none" role="alert"></div>
        
        <!-- Welcome message -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Bienvenido, <span id="user-name">Usuario</span>!</h5>
                <p class="card-text">Este es el panel de control del Sistema de Inventario. Desde aquí puedes administrar todos los aspectos de tu inventario.</p>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="row stats-container mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stats-card primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Total Productos</h6>
                                <h3 id="total-products">--</h3>
                            </div>
                            <div class="fs-1 text-primary">
                                <i class="bi bi-box-seam"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Valor Total</h6>
                                <h3 id="total-value">--</h3>
                            </div>
                            <div class="fs-1 text-success">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Categorías</h6>
                                <h3 id="total-categories">--</h3>
                            </div>
                            <div class="fs-1 text-warning">
                                <i class="bi bi-tags"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted mb-1">Bajo Stock</h6>
                                <h3 id="low-stock">--</h3>
                            </div>
                            <div class="fs-1 text-danger">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Products Table -->
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Productos Recientes</h5>
                <a href="products.html" class="btn btn-sm btn-primary">Ver Todos</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="recent-products">
                            <tr>
                                <td colspan="5" class="text-center">Cargando productos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">Sistema de Inventario &copy; 2025</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/products.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireAuth()) {
                return;
            }
            
            // Update user name
            const user = getCurrentUser();
            if (user) {
                document.getElementById('user-name').textContent = user.username;
            }
            
            // Show/hide admin panel link based on role
            const adminPanelLink = document.getElementById('admin-panel-link');
            if (!hasRole('ADMIN')) {
                adminPanelLink.classList.add('d-none');
            }
            
            // Load dashboard data
            loadDashboardData();
        });
        
        
        // Load dashboard data
function loadDashboardData() {
    fetch(`${API_URL}/api/products`, {
        method: 'GET',
        headers: getAuthHeaders()
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('No se pudieron cargar los productos');
        }
        return response.json();
    })
    .then(products => {
        // Update stats
        document.getElementById('total-products').textContent = products.length;
        
        // Calculate total value
        const totalValue = products.reduce((sum, product) => sum + (product.price * product.quantity), 0);
        document.getElementById('total-value').textContent = formatCurrency(totalValue);
        
        // Count categories
        const categories = new Set(products.map(product => product.category));
        document.getElementById('total-categories').textContent = categories.size;
        
        // Count low stock products (less than 5)
        const lowStock = products.filter(product => product.quantity < 5).length;
        document.getElementById('low-stock').textContent = lowStock;
        
        // Update recent products table
        const recentProductsTable = document.getElementById('recent-products');
        
        if (products.length === 0) {
            recentProductsTable.innerHTML = '<tr><td colspan="5" class="text-center">No hay productos disponibles en este momento</td></tr>';
            return;
        }
        
        recentProductsTable.innerHTML = '';
        
        // Show only the 5 most recent products
        const recentProducts = products.slice(0, 5);
        
        recentProducts.forEach(product => {
            const row = document.createElement('tr');
            
            // Determinar el color del badge según la cantidad
            let badgeClass = '';
            if (product.quantity < 5) {
                badgeClass = 'bg-danger'; // Rojo para cantidades menores a 5
            } else if (product.quantity >= 5 && product.quantity <= 10) {
                badgeClass = 'bg-warning'; // Amarillo para cantidades entre 5 y 10
            } else {
                badgeClass = 'bg-success'; // Verde para cantidades mayores a 10
            }
            
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.category || '-'}</td>
                <td><span class="badge ${badgeClass}">${product.quantity}</span></td>
                <td>${formatCurrency(product.price)}</td>
                <td>
                    <a href="product-form.html?id=${product.id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                </td>
            `;
            
            recentProductsTable.appendChild(row);
        });
    })
    .catch(error => {
        showAlert('#dashboard-alert', handleApiError(error));
    });
}
    </script>
</body>
</html>